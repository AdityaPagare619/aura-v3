name: Test Termux Install
on:
  push:
    branches: [production-hardening, main]
    paths:
      - 'scripts/termux_install.sh'
      - 'src/**/*.py'
      - '.github/workflows/test-termux-install.yml'
  pull_request:
    branches: [production-hardening, main]
    paths:
      - 'scripts/termux_install.sh'
      - 'src/**/*.py'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─── Syntax & Import Check (fast, no emulation) ────────────────────────
  python-checks:
    name: Python 3.12 Compatibility
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Verify no deprecated asyncio patterns
        run: |
          echo "=== Checking for asyncio.coroutine (removed in 3.11) ==="
          if grep -rn 'asyncio\.coroutine' src/ --include='*.py'; then
            echo "❌ FAIL: asyncio.coroutine found (removed in Python 3.11)"
            exit 1
          fi
          echo "✓ No asyncio.coroutine found"

          echo ""
          echo "=== Checking for deprecated asyncio.get_event_loop() ==="
          if grep -rn 'asyncio\.get_event_loop()' src/ --include='*.py'; then
            echo "❌ FAIL: asyncio.get_event_loop() found (deprecated in 3.10+)"
            exit 1
          fi
          echo "✓ No deprecated asyncio.get_event_loop() calls"

      - name: Compile all Python modules
        run: |
          echo "=== Compiling all .py files with Python ${{ matrix.python-version }} ==="
          FAILED=0
          TOTAL=0
          for f in $(find src/ -name '*.py' -not -path '*__pycache__*'); do
            TOTAL=$((TOTAL + 1))
            if python -m py_compile "$f" 2>/dev/null; then
              echo "✓ $f"
            else
              echo "❌ $f"
              FAILED=$((FAILED + 1))
            fi
          done
          echo ""
          echo "=== Results: $((TOTAL - FAILED))/$TOTAL passed ==="
          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi

      - name: Install core dependencies
        run: |
          pip install --upgrade pip
          pip install aiofiles pyyaml psutil python-telegram-bot

      - name: Test critical imports
        run: |
          cd $GITHUB_WORKSPACE
          echo "=== Testing boot-critical imports ==="
          python -c "
          import sys
          sys.path.insert(0, '.')

          # Test 1: health_monitor (the crash point)
          from src.utils.health_monitor import HealthMonitor
          print('✓ health_monitor imports')

          # Test 2: graceful_shutdown
          from src.utils.graceful_shutdown import GracefulShutdownManager
          print('✓ graceful_shutdown imports')

          # Test 3: memory
          from src.memory.memory_retrieval import MemoryRetrieval
          print('✓ memory_retrieval imports')

          # Test 4: learning engine
          from src.learning.engine import LearningEngine
          print('✓ learning engine imports')

          # Test 5: background manager
          from src.services.background_manager import BackgroundManager
          print('✓ background_manager imports')

          print('')
          print('All boot-critical imports passed!')
          "

  # ─── Shell Script Lint ─────────────────────────────────────────────────
  shellcheck:
    name: Installer Script Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Lint installer script
        run: |
          # SC2034: unused vars (colors, globals) — expected
          # SC2086: word splitting — intentional for pkg lists
          # SC2059: printf format — using variables in echo -e
          shellcheck scripts/termux_install.sh \
            --exclude=SC2034,SC2086,SC2059 \
            --severity=error || true

      - name: Verify script syntax
        run: bash -n scripts/termux_install.sh

  # ─── Termux-Like Docker Test ───────────────────────────────────────────
  termux-simulation:
    name: Termux Simulation (ARM via QEMU)
    runs-on: ubuntu-latest
    needs: [python-checks, shellcheck]
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU for ARM
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Test installer in ARM container
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -e TERMUX_VERSION=0.118.3 \
            -e PREFIX=/usr \
            python:3.12-slim-bookworm \
            bash -c '
              set -x
              cd /workspace

              # Simulate minimal Termux environment
              mkdir -p /data/data/com.termux/files/home
              export HOME=/data/data/com.termux/files/home

              # Test Python compatibility
              python3 -m py_compile src/utils/health_monitor.py
              python3 -m py_compile src/utils/graceful_shutdown.py
              python3 -m py_compile src/memory/memory_retrieval.py
              python3 -m py_compile src/learning/engine.py
              python3 -m py_compile src/services/background_manager.py
              python3 -m py_compile src/voice/pipeline.py
              python3 -m py_compile src/tools/android.py

              echo ""
              echo "=== All boot-critical files compile on ARM/Python 3.12 ==="

              # Install deps and test imports
              pip install aiofiles pyyaml psutil python-telegram-bot --quiet
              python3 -c "
              import sys
              sys.path.insert(0, \"/workspace\")
              from src.utils.health_monitor import HealthMonitor
              from src.utils.graceful_shutdown import GracefulShutdownManager
              print(\"All ARM imports passed!\")
              "
            '
